<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Twitch コメントビューア</title>
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
    #left { flex: 2; display: flex; flex-direction: column; }
    #video { flex: 1; }
    #right { flex: 1; display: flex; flex-direction: column; border-left: 2px solid #ccc; }
    #controls { padding: 8px; border-bottom: 1px solid #ccc; }
    #scrollChat { flex: 1; overflow-y: auto; background: #111; color: #fff; padding: 5px; }
    .msg { margin: 2px 0; }
    #danmakuOverlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
      overflow: hidden;
    }
    .danmaku {
      position: absolute;
      white-space: nowrap;
      font-size: 18px;
      color: white;
      text-shadow: 1px 1px 2px black;
      animation: move 8s linear forwards;
    }
    @keyframes move {
      from { transform: translateX(100%); }
      to { transform: translateX(-100%); }
    }
  </style>
</head>
<body>
  <div id="left">
    <div id="video">
      <iframe id="twitchPlayer" src="" height="100%" width="100%" frameborder="0" allowfullscreen></iframe>
      <div id="danmakuOverlay"></div>
    </div>
  </div>
  <div id="right">
    <div id="controls">
      <input id="streamUrl" type="text" placeholder="Twitch配信URLを入力" style="width:80%">
      <button onclick="loadStream()">読み込み</button>
    </div>
    <div id="scrollChat"></div>
  </div>

  <script src="https://unpkg.com/tmi.js@1.8.5"></script>
  <script>
    const CLIENT_ID = "gp762nuuoqcoxypju8c569th9wz7q5";
    const ACCESS_TOKEN = "dhhuflzw1a3t7ags4guuq9yzywwjbg";

    let client;
    const scrollChat = document.getElementById("scrollChat");
    const danmakuOverlay = document.getElementById("danmakuOverlay");

    function loadStream(){
      const url = document.getElementById("streamUrl").value.trim();
      const match = url.match(/twitch\.tv\/([a-zA-Z0-9_]+)/);
      if(!match){ alert("正しいTwitchリンクを入力してください"); return; }
      const channel = match[1];

      // 動画埋め込み
      document.getElementById("twitchPlayer").src =
        `https://player.twitch.tv/?channel=${channel}&parent=${location.hostname}`;

      // 既存接続終了
      if(client) client.disconnect();

      // tmi.js でチャット取得
      client = new tmi.Client({
        channels: [channel]
      });

      client.connect();

      client.on("message", (chan, tags, message, self) => {
        if(self) return;

        // スクロール型チャット
        const div = document.createElement("div");
        div.className = "msg";
        div.textContent = `${tags["display-name"]}: ${message}`;
        scrollChat.appendChild(div);
        scrollChat.scrollTop = scrollChat.scrollHeight;

        // 弾幕型チャット
        const span = document.createElement("div");
        span.className = "danmaku";
        span.textContent = message;
        span.style.top = `${Math.random()*80}%`;
        danmakuOverlay.appendChild(span);
        setTimeout(()=>span.remove(), 8000);
      });
    }
  </script>
</body>
</html>
